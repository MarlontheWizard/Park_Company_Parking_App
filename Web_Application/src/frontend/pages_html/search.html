<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Park Finder - Search</title>
    <link rel="stylesheet" href="/pages_css/style.css">
</head>
<body>
    <main class="search-page">
        <header class="page-header">
            <h1>Search for Parking</h1>
            <p class="page-header-sub">Enter a location and we’ll show nearby spots you can book.</p>
        </header>

        <form class="search-form" id="search-form">
            <label for="location">Location:</label>
            <input type="text" id="location" placeholder="Enter city or ZIP code">

            <label for="time">Time Duration:</label>
            <input type="number" id="time" placeholder="Hours">

            <label for="vehicle">Vehicle Type:</label>
            <select id="vehicle">
                <option value="car">Car</option>
                <option value="motorcycle">Motorcycle</option>
                <option value="truck">Truck</option>
            </select>

            <button type="submit" class="button">Find Parking</button>
        </form>

        <section class="map-section">
            <h2>Map View</h2>
            <div id="map" style="height: 400px; width: 100%;"></div>
        </section>

        <!-- Parking Spots List -->
        <section class="parking-list" id="parking-list-section">
            <h2>Parking Spots</h2>
            <p id="parking-status"></p>
            <ul id="parking-list">
                <!-- List of parking spots will be populated here -->
            </ul>
        </section>

        <!-- Reservation Form (shown after selecting a spot) -->
        <section id="reservation-form" class="reservation-form-card" style="display:none;">
            <h2>Book your spot</h2>
            <p id="selected-spot-name" class="selected-spot-name"></p>
            <p class="change-spot-wrap"><a href="#" id="change-spot-link" class="change-spot-link">← Change parking spot</a></p>
            <form id="reservationDetailsForm">
                <input type="hidden" id="parkingSpotId">
                <label for="reservationTime">Select date and time</label>
                <input type="datetime-local" id="reservationTime" required>
                <button type="submit" class="button">Proceed to payment</button>
            </form>
        </section>
    </main>

    <script>
        let map;
        let service;
        let markers = [];
        let searchCenter = null;
        const parkingListElement = document.getElementById('parking-list');
        const parkingStatusElement = document.getElementById('parking-status');
        const reservationFormElement = document.getElementById('reservation-form');

        // Initialize the map
        function initMap() {
            const centerLocation = { lat: 39.9526, lng: -75.1652 }; // Default: Philadelphia
            map = new google.maps.Map(document.getElementById('map'), {
                center: centerLocation,
                zoom: 12
            });
        }

        // Add the Google Maps script dynamically
        function loadGoogleMapsAPI() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyDFbLw6QN-OI-1VkXz5GZ3wGstAgCC4hA4&libraries=places,geometry&callback=initMap`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }

        // Call this to initialize the API when the page loads
        window.onload = loadGoogleMapsAPI;

        // Handle the search form submission
        document.getElementById('search-form').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent form submission
            findParking();
        });

        // Demo parking spots when Google Places returns nothing or API fails (e.g. key/billing)
        const DEMO_SPOTS = [
            { place_id: 'demo_1', name: 'Center City Parking Garage', address: '1234 Market St, Philadelphia, PA', distanceMeters: 250, rating: '4.2' },
            { place_id: 'demo_2', name: 'Liberty Park & Ride', address: '501 N 9th St, Philadelphia, PA', distanceMeters: 520, rating: '4.0' },
            { place_id: 'demo_3', name: 'Convention Center Lot', address: '1101 Arch St, Philadelphia, PA', distanceMeters: 800, rating: '3.8' },
            { place_id: 'demo_4', name: 'Old City Parking', address: '215 Chestnut St, Philadelphia, PA', distanceMeters: 1200, rating: '4.5' },
            { place_id: 'demo_5', name: 'South Street Lot', address: '500 South St, Philadelphia, PA', distanceMeters: 1500, rating: '3.9' }
        ];

        function showDemoSpots() {
            parkingStatusElement.textContent = 'Showing demo parking spots (select one to test the payment flow). For live results, set up a Google Places API key with billing enabled.';
            parkingListElement.innerHTML = '';
            DEMO_SPOTS.forEach(function(spot) {
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <div class="parking-item" data-place-id="${escapeAttr(spot.place_id)}" data-place-name="${escapeAttr(spot.name)}">
                        <div class="parking-item-content">
                            <strong>${escapeHtml(spot.name)}</strong>
                            <span class="parking-item-address">${escapeHtml(spot.address)}</span>
                            <span class="parking-item-meta">${formatDistance(spot.distanceMeters)} away · Rating ${spot.rating}</span>
                            <button type="button" class="button book-now-btn">Select &amp; proceed to payment</button>
                        </div>
                    </div>
                `;
                parkingListElement.appendChild(listItem);
            });
            document.getElementById('parking-list-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
            parkingListElement.querySelectorAll('.book-now-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const item = this.closest('.parking-item');
                    if (item) selectReservation(item.dataset.placeId, item.dataset.placeName);
                });
            });
        }

        // Function to find parking
        function findParking() {
            const location = document.getElementById('location').value;
            if (!location) {
                alert("Please enter a location.");
                return;
            }

            // Clear previous results and show list section
            parkingListElement.innerHTML = '';
            document.getElementById('parking-list-section').style.display = 'block';
            reservationFormElement.style.display = 'none';
            parkingStatusElement.textContent = 'Searching nearby parking spots...';
            clearMarkers();

            // If Google Maps API didn't load (e.g. invalid key), show demo spots
            if (typeof google === 'undefined' || !google.maps || !google.maps.Geocoder) {
                parkingStatusElement.textContent = 'Maps API not available. Showing demo spots so you can test the flow.';
                showDemoSpots();
                return;
            }

            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: location }, (results, status) => {
                if (status !== 'OK' || !results[0]) {
                    parkingStatusElement.textContent = 'Could not find that location. Showing demo spots so you can still test the payment flow.';
                    showDemoSpots();
                    return;
                }

                map.setCenter(results[0].geometry.location);
                searchCenter = results[0].geometry.location;
                service = new google.maps.places.PlacesService(map);
                service.nearbySearch({
                    location: results[0].geometry.location,
                    radius: 2000,
                    type: 'parking'
                }, function(results, status) {
                    if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                        displayResults(results, status);
                    } else {
                        service.textSearch({ query: 'parking near ' + location }, function(fallbackResults, fallbackStatus) {
                            if (fallbackStatus === google.maps.places.PlacesServiceStatus.OK && fallbackResults && fallbackResults.length > 0) {
                                displayResults(fallbackResults, fallbackStatus);
                            } else {
                                parkingStatusElement.textContent = 'No live results for this area. Showing demo spots so you can test selecting a spot and payment.';
                                showDemoSpots();
                            }
                        });
                    }
                });
            });
        }

        function renderParkingResults(results) {
            if (!results || results.length === 0) {
                parkingStatusElement.textContent = 'No parking spots found for this location. Try a nearby city or landmark.';
                return;
            }

            const rankedResults = results
                .filter((place) => place.geometry && place.geometry.location)
                .map((place) => {
                    const distanceMeters = searchCenter
                        ? google.maps.geometry.spherical.computeDistanceBetween(searchCenter, place.geometry.location)
                        : Number.MAX_SAFE_INTEGER;

                    return {
                        place,
                        distanceMeters
                    };
                })
                .sort((a, b) => a.distanceMeters - b.distanceMeters)
                .slice(0, 10);

            if (rankedResults.length === 0) {
                parkingStatusElement.textContent = 'No parking spots found for this location. Try a nearby city or landmark.';
                return;
            }

            parkingStatusElement.textContent = `Showing ${rankedResults.length} parking spots — select one and proceed to payment.`;

            rankedResults.forEach(({ place, distanceMeters }) => {
                const marker = new google.maps.Marker({
                    map: map,
                    position: place.geometry.location,
                    title: place.name
                });
                markers.push(marker);

                const photoUrl = place.photos ? place.photos[0].getUrl({ maxWidth: 400, maxHeight: 200 }) : '';
                const name = escapeHtml(place.name);
                const address = escapeHtml(place.vicinity || place.formatted_address || 'Address unavailable');

                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <div class="parking-item" data-place-id="${escapeAttr(place.place_id)}" data-place-name="${escapeAttr(place.name)}">
                        ${photoUrl ? `<img src="${photoUrl}" alt="${name}">` : ''}
                        <div class="parking-item-content">
                            <strong>${name}</strong>
                            <span class="parking-item-address">${address}</span>
                            <span class="parking-item-meta">${formatDistance(distanceMeters)} away · Rating ${place.rating || 'N/A'}</span>
                            <button type="button" class="button book-now-btn">Select &amp; proceed to payment</button>
                        </div>
                    </div>
                `;
                parkingListElement.appendChild(listItem);
            });

            // Scroll list into view so user sees results
            document.getElementById('parking-list-section').scrollIntoView({ behavior: 'smooth', block: 'start' });

            // Delegated click for "Select & proceed to payment"
            parkingListElement.querySelectorAll('.book-now-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const item = this.closest('.parking-item');
                    if (item) {
                        selectReservation(item.dataset.placeId, item.dataset.placeName);
                    }
                });
            });
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function escapeAttr(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        function formatDistance(distanceMeters) {
            if (!Number.isFinite(distanceMeters)) {
                return 'N/A';
            }

            if (distanceMeters < 1000) {
                return `${Math.round(distanceMeters)} m`;
            }

            return `${(distanceMeters / 1000).toFixed(2)} km`;
        }

        // Function to display results
        function displayResults(results, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                renderParkingResults(results);
            } else {
                service.textSearch({ query: `parking near ${document.getElementById('location').value}` }, (fallbackResults, fallbackStatus) => {
                    if (fallbackStatus === google.maps.places.PlacesServiceStatus.OK) {
                        renderParkingResults(fallbackResults);
                        return;
                    }

                    parkingStatusElement.textContent = 'No parking spots found for this location. Try a nearby city or landmark.';
                });
            }
        }

        // Function to show the reservation form and store the selected parking spot
        function selectReservation(placeId, name) {
            document.getElementById('parkingSpotId').value = placeId;
            document.getElementById('selected-spot-name').textContent = name;
            document.getElementById('parking-list-section').style.display = 'none';
            reservationFormElement.style.display = 'block';
            reservationFormElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Change spot: show list again, hide reservation form
        document.getElementById('change-spot-link').addEventListener('click', function(e) {
            e.preventDefault();
            reservationFormElement.style.display = 'none';
            document.getElementById('parking-list-section').style.display = 'block';
            document.getElementById('parking-list-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
        });

        // Handle reservation form submission
        document.getElementById('reservationDetailsForm').addEventListener('submit', function(event) {
            
            event.preventDefault(); // Prevent the form from submitting normally

            const reservationTime = document.getElementById('reservationTime').value;
            const parkingSpotId = document.getElementById('parkingSpotId').value;

            if (!reservationTime) {
                alert("Please select a time for the reservation.");
                return;
            }

            // Send reservation data to the backend to create the Stripe session
            fetch('/payment/create-checkout-session.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ spotId: parkingSpotId, reservationTime: reservationTime })
            })
            .then(response => response.json())
            .then(data => {
                if (data.checkoutUrl) {
                    window.location.href = data.checkoutUrl;
                } else if (data.error === 'User not logged in') {
                    if (confirm('You need to log in to proceed to payment. Go to login now?')) {
                        window.location.href = '/pages_php/login.php?redirect=' + encodeURIComponent(window.location.pathname + window.location.search);
                    }
                } else {
                    alert(data.error || 'Error creating payment session. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while processing your payment. Please check your connection and try again.');
            });
        });

        // Clear markers from the map
        function clearMarkers() {
            markers.forEach(marker => {
                marker.setMap(null);
            });
            markers = [];
        }
    </script>
</body>
</html>
